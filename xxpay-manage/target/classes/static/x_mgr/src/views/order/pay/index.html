<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>订单管理</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-tab layui-tab-brief">
            <ul class="layui-tab-title">
                <li class="layui-this">支付订单</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="layui-row">
                        <div class="layui-form" style="float:right; margin-bottom: 10px;">
                            <div class="layui-form-item" style="margin:0;">
                                <div class="layui-input-inline">
                                    <input type="text" name="createTimeStart" id="createTimeStart" autocomplete="off"
                                           placeholder="开始时间" class="layui-input" value="">
                                </div>

                                <div class="layui-input-inline">
                                    <input type="text" name="createTimeEnd" id="createTimeEnd" autocomplete="off"
                                           placeholder="结束时间" class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="paySuccessTimeStart" id="paySuccessTimeStart"
                                           autocomplete="off"
                                           placeholder="支付完成开始时间" class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="paySuccessTimeEnd" id="paySuccessTimeEnd"
                                           autocomplete="off"
                                           placeholder="支付完成结束时间" class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="mchId" id="mchId" placeholder="商户ID" autocomplete="off"
                                           class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="payOrderId" id="payOrderId" placeholder="支付订单号"
                                           autocomplete="off" class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="mchOrderNo" id="mchOrderNo" placeholder="商户订单号"
                                           autocomplete="off" class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <select name="productId" id="productId" lay-search="">
                                        <option value="-99">支付产品</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline">
                                    <select name="passageId" id="passageId" lay-search="">
                                        <option value="-99">支付通道</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline">
                                    <select name="type" id="productType" placeholder="产品类型" lay-search="">
                                        <option value="-99">产品类型</option>
                                        <option value="1">收款</option>
                                        <option value="2">充值</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline">
                                    <select name="status" id="status" lay-search="">
                                        <option value="-99">订单状态</option>
                                        <option value="0">订单生成</option>
                                        <option value="1">支付中</option>
                                        <option value="2">支付成功</option>
                                        <option value="-1">支付失败</option>
                                        <option value="3">处理完成</option>
                                        <option value="4">已退款</option>
                                    </select>
                                </div>

                                <div class="layui-input-inline">
                                    <select name="highest" id="highest" lay-search="">
                                        <option value="-99">回调状态</option>
                                        <option value="1">非正常回调</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="minAmount" id="minAmount" placeholder="最小交易金额"
                                           autocomplete="off" class="layui-input">
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="maxAmount" id="maxAmount" placeholder="最大交易金额"
                                           autocomplete="off" class="layui-input">
                                </div>
                                <button id="exportOrder" class="layui-btn">导出EXCEL</button>
                                <button id="search" class="layui-btn" data-type="reload">搜索</button>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <blockquote class="layui-elem-quote" id="amountTip">
                                提交订单数:
                                <sapn id="allTotalCount" style="color: blue; margin-right: 10px;"></sapn>
                                订单总金额:<span id="allTotalAmount" style="color: blue; margin-right: 10px;"></span>
                                已付订单数:<span id="successTotalCount" style="color: green; margin-right: 10px;"></span>
                                已付总金额:<span id="successTotalAmount" style="color: green; margin-right: 10px;"></span>
                                商户总收入:<span id="successTotalMchIncome" style="color: green; margin-right: 10px;"></span>
                                代理商收入:<span id="successTotalAgentProfit"
                                            style="color: green; margin-right: 10px;"></span>
                                平台收入:<span id="successTotalPlatProfit" style="color: green; margin-right: 10px;"></span>
                                未付订单数:<span id="failTotalCount" style="color: red; margin-right: 10px;"></span>
                                未付总金额:<span id="failTotalAmount" style="color: red; margin-right: 10px;"></span>
                                成功率:<span id="successRate" style="color: red; margin-right: 10px;"></span>
                                <!--商户入账:<span id="mchIncome" style="color: red; margin-right: 10px;"></span>-->
                            </blockquote>
                        </div>
                    </div>
                    <table id="XxPay_Mgr_PayOrder_dataAll" lay-filter="XxPay_Mgr_PayOrder_dataAll"></table>
                </div>

            </div>
        </div>
    </div>
</div>
<!---->
<script type="text/html" id="xxpayBar">


    {{#  if(d.status == 2){ }}
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="sendNotify">补发通知</a>
    {{#  } else { }}
    {{#  } }}

    {{#  if((d.status == 2 || d.status==3) && (d.passageId==1044 || d.passageId==1058||d.passageId==1128)){ }}
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="refund">退款</a>
    {{#  } else { }}
    <!--    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="none"></a>-->
    {{#  } }}

    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="searchUpperOrder">查看上游订单</a>
    {{#  if(d.status == 1){ }}
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="reissue">补单</a>
    {{#  } else { }}
    {{#  } }}


</script>

<script>

    layui.config({
        base: 'layui/layui_exts/',
    }).extend({
        excel: 'excel'
    });

    layui.use(['admin', 'table', 'util', 'laydate', 'excel', 'util'], function () {

        var $ = layui.$
            , admin = layui.admin
            , table = layui.table
            // , util = layui.util
            , element = layui.element
            , laydate = layui.laydate
            , excel = layui.excel
            , form = layui.form;

        element.render('breadcrumb', 'breadcrumb');


        $.setCountResult = function (mchId, passageId, productId, payOrderId, mchOrderNo, productType, createTimeStart, createTimeEnd, paySuccessTimeStart, paySuccessTimeEnd, paySuccTime, highest, minAmount, maxAmount) {
            admin.req({
                type: 'get',
                url: layui.setter.baseUrl + '/pay_order/count',
                data: {
                    mchId: mchId,
                    passageId: passageId,
                    productId: productId,
                    payOrderId: payOrderId,
                    mchOrderNo: mchOrderNo,
                    productType: productType,
                    createTimeStart: createTimeStart,
                    createTimeEnd: createTimeEnd,
                    paySuccessTimeStart: paySuccessTimeStart,
                    paySuccessTimeEnd: paySuccessTimeEnd,
                    paySuccTime: paySuccTime,
                    minAmount: minAmount,
                    maxAmount: maxAmount
                },
                error: function (err) {
                    layer.alert(JSON.stringify(err.field), {
                        title: '错误提示'
                    })
                },
                success: function (res) {
                    if (res.code == 0) {
                        $('#allTotalCount').html(res.data.allTotalCount);
                        $('#allTotalAmount').html("￥" + res.data.allTotalAmount / 100.00);
                        $('#successTotalCount').html(res.data.successTotalCount);
                        $('#successTotalAmount').html("￥" + res.data.successTotalAmount / 100.00);
                        $('#successTotalMchIncome').html("￥" + res.data.successTotalMchIncome / 100.00);
                        $('#successTotalAgentProfit').html("￥" + res.data.successTotalAgentProfit / 100.00);
                        $('#successTotalPlatProfit').html("￥" + res.data.successTotalPlatProfit / 100.00);
                        $('#failTotalCount').html(res.data.failTotalCount);
                        $('#failTotalAmount').html("￥" + res.data.failTotalAmount / 100.00);
                        if (res.data.successTotalCount != 0) {
                            $('#successRate').html(+(res.data.successTotalCount / res.data.allTotalCount * 100).toFixed(2) + "%");
                        } else {
                            $('#successRate').html("0%");
                        }
                    }
                }
            });
        };

        // 加载支付产品
        admin.req({
            type: 'post',
            url: layui.setter.baseUrl + '/config/common/pay_product_all',
            error: function (err) {
                layer.alert(err);
            },
            success: function (res) {
                if (res.code == 0) {
                    var payProductList = res.data;
                    //遍历赋值
                    for (var i in payProductList) {
                        $("#productId").append('<option value= ' + payProductList[i].id + '>' + payProductList[i].productName + '</option>');
                    }
                    form.render('select');
                }
            }
        });

        // 加载支付通道
        admin.req({
            type: 'post',
            url: layui.setter.baseUrl + '/config/common/pay_passage_all',
            error: function (err) {
                layer.alert(err);
            },
            success: function (res) {
                if (res.code == 0) {
                    var payPassageList = res.data;
                    //遍历赋值
                    for (var i in payPassageList) {
                        $("#passageId").append('<option value= ' + payPassageList[i].id + '>' + payPassageList[i].passageName + '</option>');
                    }
                    form.render('select');
                }
            }
        });

        var tplStatus = function (d) {
            if (d.status == 0) {
                return "<span style='color: blue'>订单生成</span>";
            } else if (d.status == 1) {
                return "<span style='color: orangered'>支付中</span>";
            } else if (d.status == 2) {
                return "<span style='color: green'>支付成功</span>";
            } else if (d.status == -1) {
                return "<span style='color: red'>支付失败</span>";
            } else if (d.status == 3) {
                return "<span style='color: darkgreen'>处理完成</span>";
            } else if (d.status == 4) {
                return "<span style='color: red'>已退款</span>";
            }
        };

        var tplpaySuccTime = function (d) {
            if (d.paySuccTime != null) {
                return layui.util.toDateString(d.paySuccTime, "yyyy-MM-dd HH:mm:ss")
            } else {
                return "未完成";
            }

        }
        // 初始化统计结果
        $.setCountResult();

        //用户列表
        table.render({
            elem: '#XxPay_Mgr_PayOrder_dataAll'
            , url: layui.setter.baseUrl + '/pay_order/list' //用户列表接口
            , where: {
                access_token: layui.data(layui.setter.tableName).access_token
            }
            , id: 'tableReload'
            , page: true
            , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'mchId', title: '商户ID', width: 100}
                , {field: 'mchName', title: '商户名称', width: 100}
                , {field: 'mchOrderNo', title: '商户单号', width: 228}
                , {field: 'payOrderId', title: '支付单号', width: 228}
                , {field: 'amount', title: '支付金额', templet: '<div>{{ d.amount/100 }}</div>', width: 88}
                , {field: 'channelId', title: '渠道Code', width: 180}
                , {field: 'passageAccountId', title: '通道账户', width: 100}
                // , {field: 'platProfit', title: '平台利润',width: 100,templet: '<div>{{ d.platProfit/100 }}</div>'}
                // , {field: 'channelCost', title: '上游通道成本',width: 110,templet: '<div>{{ d.channelCost/100 }}</div>'}
                /*, {
                    field: 'productType',
                    title: '产品类型',
                    width: 88,
                    templet: '<div>{{ d.productType == 1 ? "收款" : d.productType == 2 ? "充值" : ""}}</div>'
                }*/
                , {field: 'status', title: '状态', width: 118, templet: tplStatus}
                , {
                    field: 'createTime',
                    title: '创建时间',
                    templet: '<div>{{ layui.util.toDateString(d.createTime, "yyyy-MM-dd HH:mm:ss") }}</div>', width: 160
                }
                , {
                    field: 'paySuccTime',
                    title: '完成时间',
                    templet: tplpaySuccTime,
                    width: 160
                }
                , {field: 'edit', title: '操作', toolbar: '#xxpayBar', width: 350}
            ]]
            , skin: 'line'
        });

        //监听工具条
        table.on('tool(XxPay_Mgr_PayOrder_dataAll)', function (obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
                location.href = layui.setter.baseLocal + "order/pay/view.html?" + data.payOrderId;
            } else if (obj.event === 'reissue') {
                var payOrderId = data.payOrderId;
                layer.prompt({
                    formType: 1,
                    title: '确认补单，请输入超级密码：'
                }, function (value, index, elem) {
                    layer.close(index);
                    var load = layer.msg('重新发送中...', {
                        icon: 16
                        , shade: 0.01
                        , time: 9999999999
                    });
                    admin.req({
                        type: 'post',
                        url: layui.setter.baseUrl + '/pay_order/reissue',
                        timeout: 1000 * 60,
                        data: {
                            payOrderId: payOrderId,
                            password: value
                        },
                        error: function (err) {
                            layer.close(load);
                            layer.alert(err);
                        },
                        success: function (res) {
                            layer.close(load);
                            if (res.code == 0) {
                                layer.alert("补单完成，请注意查看状态！");
                                table.reload("tableReload");
                            }
                        }
                    });
                });
            } else if (obj.event == "searchUpperOrder") {
                var payOrderId = data.payOrderId;
                var mchOrderNo = data.mchOrderNo;
                var load = layer.msg('查询中...', {
                    icon: 16
                    , shade: 0.01
                    , time: 9999999999
                });
                admin.req({
                    type: 'post',
                    url: layui.setter.baseUrl + '/pay_order/searchupperOrder',
                    timeout: 1000 * 60,
                    data: {
                        orderId: payOrderId,
                        mchOrderId: mchOrderNo
                    },
                    error: function (err) {
                        layer.close(load);
                        layer.alert(err);
                    },
                    success: function (res) {
                        layer.close(load);
                        if (res.code == 0) {
                            // "响应Code:1003,订单状态:支付中"
                            var str = "订单号：" + data.payOrderId + ",上游查询信息：";
                            layer.alert(str + res.data.retMsg);
                        }
                    }
                });
            } else if (obj.event == 'refund') {

                layer.confirm('确认退款?', function (index) {
                    admin.req({
                        type: 'post',
                        url: layui.setter.baseUrl + '/refund_order/alipayrefundorder',
                        timeout: 1000 * 60,
                        data: {
                            payOrderId: data.payOrderId,
                            mchId: data.mchId
                        },
                        error: function (err) {
                            layer.close(load);
                            layer.alert(err);
                        },
                        success: function (res) {
                            layer.close(load);
                            if (res.code == 0 && res.data.retCode == 'SUCCESS' && res.data.resCode == 'SUCCESS') {
                                layer.alert(res.data.channelErrMsg);
                                table.reload("tableReload");
                            } else {
                                layer.alert("退款失败，失败原因：" + res.data.channelErrMsg);
                            }
                        }
                    });
                });
            } else if (obj.event == 'sendNotify') {
                admin.req({
                    type: 'post',
                    url: layui.setter.baseUrl + '/pay_order/sendNotify',
                    timeout: 1000 * 60,
                    data: {
                        payOrderId: data.payOrderId,
                    },
                    error: function (err) {
                        layer.close(load);
                        layer.alert(err);
                    },
                    success: function (res) {
                        layer.close(load);
                        if (res.code == 0) {
                            layer.alert(res.data.msg);
                            table.reload("tableReload");
                        }
                    }
                });
            }
        });

        // 搜索
        var $ = layui.$, active = {
            reload: function () {
                var mchId = $('#mchId').val();
                var passageId = $('#passageId').val();
                var productId = $('#productId').val();
                var payOrderId = $('#payOrderId').val();
                var minAmount = $("#minAmount").val();
                var maxAmount = $("#maxAmount").val();
                var mchOrderNo = $("#mchOrderNo").val();
                var productType = $("#productType").val();
                var paySuccessTimeStart = $('#paySuccessTimeStart').val();
                var paySuccessTimeEnd = $('#paySuccessTimeEnd').val();
                var createTimeStart = $('#createTimeStart').val();
                var createTimeEnd = $('#createTimeEnd').val();
                var paySuccTime = $('#paySuccTime').val();
                var status = $("#status").val();
                var highest = $("#highest").val();

                $.setCountResult(mchId, passageId, productId, payOrderId, mchOrderNo, productType, createTimeStart, createTimeEnd, paySuccessTimeStart, paySuccessTimeEnd, paySuccTime, highest, minAmount, maxAmount);
                //执行重载
                table.reload('tableReload', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    , where: {
                        mchId: mchId,
                        passageId: passageId,
                        productId: productId,
                        payOrderId: payOrderId,
                        mchOrderNo: mchOrderNo,
                        productType: productType,
                        status: status,
                        createTimeStart: createTimeStart,
                        createTimeEnd: createTimeEnd,
                        paySuccessTimeStart: paySuccessTimeStart,
                        paySuccessTimeEnd: paySuccessTimeEnd,
                        paySuccTime: paySuccTime,
                        highest: highest,
                        minAmount: minAmount,
                        maxAmount: maxAmount
                    }
                });
            }
        };

        // 导出
        $('#exportOrder').on('click', function () {
            var mchId = $('#mchId').val();
            var passageId = $('#passageId').val();
            var productId = $('#productId').val();
            var payOrderId = $('#payOrderId').val();
            var mchOrderNo = $("#mchOrderNo").val();
            var productType = $("#productType").val();
            var createTimeStart = $('#createTimeStart').val();
            var createTimeEnd = $('#createTimeEnd').val();
            var paySuccessTimeStart = $('#paySuccessTimeStart').val();
            var paySuccessTimeEnd = $('#paySuccessTimeEnd').val();
            var status = $("#status").val();
            var highest = $("#highest").val();
            var minAmount = $("#minAmount").val();
            var maxAmount = $("#maxAmount").val();

            /*
                        //判断下载前是否选择了日期
                        if(createTimeStart===""||createTimeEnd===""){
                            layer.alert("请同时选择开始日期和结束日期");
                            return false;
                        }
                        var days = daysBetween(createTimeStart,createTimeEnd);
                        if(days>1){
                            layer.alert("开始日期和结束日期不能大于一天");
                        }
                        if(days<1){
                            layer.alert("结束日期不能大于开始日期");
                        }*/
            function daysBetween(sDate1, sDate2) {
                //Date.parse() 解析一个日期时间字符串，并返回1970/1/1 午夜距离该日期时间的毫秒数
                var time1 = Date.parse(sDate1);
                var time2 = Date.parse(new Date(sDate2));
                var nDays = parseFloat((time2 - time1) / 1000 / 3600 / 24);
                return nDays;
            };

            var accessToken = layui.data(layui.setter.tableName).access_token;

            var reqUrl = layui.setter.baseUrl + '/pay_order/history_export' + '?' +
                'access_token=' + accessToken +
                '&createTimeStart=' + createTimeStart +
                '&createTimeEnd=' + createTimeEnd +
                '&paySuccessTimeStart=' + paySuccessTimeStart +
                '&paySuccessTimeEnd=' + paySuccessTimeEnd +
                '&mchId=' + mchId +
                '&passageId=' + passageId +
                '&productId=' + productId +
                '&payOrderId=' + payOrderId +
                '&mchOrderNo=' + mchOrderNo +
                '&productType=' + productType +
                '&status=' + status +
                '&highest=' + highest +
                '&minAmount=' + minAmount +
                '&maxAmount=' + maxAmount
            // layer.alert("开始导出订单");

            var index = layer.load(1, exportFile(reqUrl));


            //关闭
            layer.close(index);

        })


        //表格导出
        function exportFile(reqUrl) {
            var headerArr = ['mchId', 'mchName', 'mchOrderNo', 'payOrderId', 'amount', 'passageName', 'mchIncome', 'productType', 'status', 'param1', 'param2'];
            var titles = {
                mchId: "商户ID ",
                mchName: "商户名称",
                mchOrderNo: "商户单号",
                payOrderId: "支付单号",
                amount: "支付金额",
                passageName: "渠道Code",
                mchIncome: "商户入账",
                productType: "产品类型",
                status: "状态",
                param1: "创建时间",
                param2: "完成时间"
            };


            $.ajax({
                url: reqUrl,
                dataType: 'json',
                success: function (res) {

                    var data = res.data;
                    // $.each(data, function (index, item) {
                    //     if (item.paySuccTime != null && item.paySuccTime) {
                    //         item.paySuccTime = layui.util.toDateString(item.paySuccTime, "yyyy-MM-dd HH:mm:ss");
                    //     }
                    //     item.createTime = layui.util.toDateString(item.createTime, "yyyy-MM-dd HH:mm:ss");
                    // })
                    data = excel.filterExportData(data, headerArr)
                    //将标题行置顶添加到数组
                    data.unshift(titles);
                    //导出excel
                    var year = new Date().getFullYear();
                    var month = new Date().getMonth() + 1;
                    var date = new Date().getDate();
                    excel.exportExcel({
                        支付订单: data
                    }, 'HistoryList_' + year + '-' + month + '-' + date + '.xlsx', 'xlsx');
                },
                error: function () {
                    layer.alert('获取数据失败');
                }

            });
        }


        $('#search').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });


        laydate.render({
            elem: '#createTimeStart'
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm:ss'
            , value: layui.util.toDateString(new Date(), "yyyy-MM-dd 00:00:00")
        });

        laydate.render({
            elem: '#createTimeEnd'
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm:ss'

        });

        laydate.render({
            elem: '#paySuccessTimeStart'
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm:ss'
        });
        laydate.render({
            elem: '#paySuccessTimeEnd'
            , type: 'datetime'
            , format: 'yyyy-MM-dd HH:mm:ss'
        });


        // 渲染表单
        form.render();
    });

    /**获取近N天*/
    function getRecentDay(day) {
        var today = new Date();
        var targetday_milliseconds = today.getTime() + 1000 * 60 * 60 * 24 * day;
        today.setTime(targetday_milliseconds);
        var tYear = today.getFullYear();
        var tMonth = today.getMonth();
        var tDate = today.getDate();
        tMonth = doHandleMonth(tMonth + 1);
        tDate = doHandleMonth(tDate);
        return tYear + "-" + tMonth + "-" + tDate;
    }

    function doHandleMonth(month) {
        var m = month;
        if (month.toString().length == 1) {
            m = "0" + month;
        }
        return m;
    }
</script>